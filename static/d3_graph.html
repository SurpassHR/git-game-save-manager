<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <style>
        html, body {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }
        svg {
            width: 100%;
            height: 100%;
        }
        .node circle {
            fill: #fff;
            stroke: steelblue;
            stroke-width: 2px;
        }
        .branch-node {
            stroke: #ff7f0e;
            stroke-width: 3px;
        }
        .link {
            fill: none;
            stroke: #ccc;
            stroke-width: 1.5px;
        }
        .commit-message {
            font-size: 12px;
            font-family: sans-serif;
        }
    </style>
</head>
<body>
    <svg>
        <defs>
            <marker id="arrowhead" viewBox="0 0 15 10" markerWidth="15" markerHeight="10"
                    refX="13" refY="5" orient="auto" markerUnits="strokeWidth">
                <path d="M0,0 L15,5 L0,10 Z" fill="#ff0000" stroke="#ff0000"/>
            </marker>
        </defs>
    </svg>
    <script src="https://d3js.org/d3.v6.min.js"></script>
    <script src="qrc:///qtwebchannel/qwebchannel.js"></script>
    <script>
        // 初始化WebChannel
        // 确保bridge对象存在
        window.bridge = window.bridge || {
            send_node_click: function(id) {
                console.log('Fallback bridge:', id);
            }
        };

        // 初始化WebChannel
        function initWebChannel() {
            if (typeof qt !== 'undefined' && qt.webChannelTransport) {
                new QWebChannel(qt.webChannelTransport, function(channel) {
                    window.bridge = channel.objects.bridge || window.bridge;
                    console.log('WebChannel ready');

                    // 确保方法存在
                    if (!window.bridge.send_node_click) {
                        window.bridge.send_node_click = function(id) {
                            console.log('Default handler:', id);
                        };
                    }
                });
            }
        }

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(initWebChannel, 100);
        });

        let svg = d3.select("svg");
        let container = svg.node().parentNode;
        let width = container.clientWidth;
        let height = container.clientHeight;

        // 窗口大小改变时重新计算尺寸
        window.addEventListener('resize', function() {
            width = container.clientWidth;
            height = container.clientHeight;
            simulation.force("center", d3.forceCenter(width/2, height/2));
            simulation.alpha(1).restart();
        });

        let simulation = d3.forceSimulation()
            .force("link", d3.forceLink().id(d => d.id).distance(100))
            .force("charge", d3.forceManyBody().strength(-300))
            .force("center", d3.forceCenter(width/2, height/2));

        function updateGraph(data) {
            // 清除旧元素
            svg.selectAll("*").remove();

            // 确保有连线数据
            if (!data.links || data.links.length === 0) {
                console.error("No links data provided");
                return;
            }

            // 创建箭头标记
            const defs = svg.append("defs");
            defs.append("marker")
                .attr("id", "arrowhead")
                .attr("viewBox", "0 0 15 10")
                .attr("markerWidth", 15)
                .attr("markerHeight", 10)
                .attr("refX", 13)
                .attr("refY", 5)
                .attr("orient", "auto")
                .append("path")
                .attr("d", "M0,0 L15,5 L0,10 Z")
                .attr("fill", "#ff0000");

            // 创建连线组
            const linkGroup = svg.append("g")
                .attr("class", "links");

            // 绘制连线
            const links = linkGroup.selectAll("line")
                .data(data.links)
                .enter()
                .append("line")
                .attr("class", "link")
                .attr("stroke", "#999")
                .attr("stroke-width", 2)
                .attr("marker-end", "url(#arrowhead)");

            // 强制显示箭头调试
            links.each(function() {
                console.log("Link created:", this);
            });

            // 创建节点
            const node = svg.append("g")
                .selectAll("circle")
                .data(data.nodes)
                .join("circle")
                .attr("r", 10)
                .attr("fill", d => d.type === "commit" ? "#1f77b4" : "#ff7f0e")
                .call(drag(simulation))
                .on("click", d => {
                    window.bridge.send_node_click(d.id);
                });

            // 添加节点标签
            const labels = svg.append("g")
                .selectAll("text")
                .data(data.nodes)
                .join("text")
                .text(d => d.message.substring(0, 20))
                .attr("x", 15)
                .attr("y", 3)
                .attr("class", "commit-message");

            simulation.nodes(data.nodes);
            simulation.force("link").links(data.links);
            simulation.alpha(1).restart();

            simulation.on("tick", () => {
                link.attr("x1", d => d.source.x)
                    .attr("y1", d => d.source.y)
                    .attr("x2", d => d.target.x)
                    .attr("y2", d => d.target.y);

                node.attr("cx", d => d.x)
                    .attr("cy", d => d.y);

                labels.attr("x", d => d.x + 15)
                      .attr("y", d => d.y + 3);
            });
        }

        function drag(simulation) {
            return d3.drag()
                .on("start", function(event, d) {
                    if (event && event.active !== undefined) {
                        simulation.alphaTarget(event.active ? 0 : 0.3).restart();
                    }
                    d.fx = d.x;
                    d.fy = d.y;
                })
                .on("drag", function(event, d) {
                    if (event) {
                        d.fx = event.x;
                        d.fy = event.y;
                    }
                })
                .on("end", function(event, d) {
                    if (event && event.active !== undefined) {
                        simulation.alphaTarget(event.active ? 0.3 : 0);
                    }
                    d.fx = null;
                    d.fy = null;
                });
        }
    </script>
</body>
</html>